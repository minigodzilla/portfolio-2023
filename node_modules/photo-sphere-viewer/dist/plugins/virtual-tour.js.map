{"version":3,"file":"virtual-tour.js","sources":["../../src/plugins/virtual-tour/AbstractDatasource.js","../../src/plugins/virtual-tour/utils.js","../../src/plugins/virtual-tour/ClientSideDatasource.js","../../src/plugins/virtual-tour/constants.js","../../src/plugins/virtual-tour/NodesListButton.js","../../src/plugins/virtual-tour/ServerSideDatasource.js","../../src/plugins/virtual-tour/index.js"],"sourcesContent":["import { PSVError } from 'photo-sphere-viewer';\n\n/**\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @private\n */\nexport class AbstractDatasource {\n\n  /**\n   * @type {Record<string, PSV.plugins.VirtualTourPlugin.Node>}\n   */\n  nodes = {};\n\n  /**\n   * @param {PSV.plugins.VirtualTourPlugin} plugin\n   */\n  constructor(plugin) {\n    this.plugin = plugin;\n  }\n\n  destroy() {\n    delete this.plugin;\n  }\n\n  /**\n   * @summary Loads a node\n   * @param {string} nodeId\n   * @return {Promise<PSV.plugins.VirtualTourPlugin.Node>}\n   */\n  loadNode(nodeId) { // eslint-disable-line no-unused-vars\n    throw new PSVError('loadNode not implemented');\n  }\n\n  /**\n   * @summary Loades nodes linked to another node\n   * @param {string} nodeId\n   * @return {Promise<void>}\n   */\n  loadLinkedNodes(nodeId) { // eslint-disable-line no-unused-vars\n    throw new PSVError('loadLinkedNodes not implemented');\n  }\n\n}\n","import { PSVError, utils } from 'photo-sphere-viewer';\n\n/**\n * @summary Checks the configuration of a node\n * @param {PSV.plugins.VirtualTourPlugin.Node} node\n * @param {boolean} isGps\n * @private\n */\nexport function checkNode(node, isGps) {\n  if (!node.id) {\n    throw new PSVError('No id given for node');\n  }\n  if (!node.panorama) {\n    throw new PSVError(`No panorama provided for node ${node.id}`);\n  }\n  if (isGps && !(node.position?.length >= 2)) {\n    throw new PSVError(`No position provided for node ${node.id}`);\n  }\n}\n\n/**\n * @summary Checks the configuration of a link\n * @param {PSV.plugins.VirtualTourPlugin.Node} node\n * @param {PSV.plugins.VirtualTourPlugin.NodeLink} link\n * @param {boolean} isGps\n * @private\n */\nexport function checkLink(node, link, isGps) {\n  if (!link.nodeId) {\n    throw new PSVError(`Link of node ${node.id} has no target id`);\n  }\n  if (!isGps && !utils.isExtendedPosition(link)) {\n    throw new PSVError(`No position provided for link ${link.nodeId} of node ${node.id}`);\n  }\n}\n\n/**\n * @summary Changes the color of a mesh\n * @param {external:THREE.Mesh} mesh\n * @param {*} color\n * @private\n */\nexport function setMeshColor(mesh, color) {\n  mesh.material.color.set(color);\n}\n\n/**\n * @summary Returns the distance between two GPS points\n * @param {number[]} p1\n * @param {number[]} p2\n * @return {number}\n * @private\n */\nexport function distance(p1, p2) {\n  return utils.greatArcDistance(p1, p2) * 6371e3;\n}\n\n/**\n * @summary Returns the bearing between two GPS points\n * {@link http://www.movable-type.co.uk/scripts/latlong.html}\n * @param {number[]} p1\n * @param {number[]} p2\n * @return {number}\n * @private\n */\nexport function bearing(p1, p2) {\n  const [λ1, φ1] = p1;\n  const [λ2, φ2] = p2;\n\n  const y = Math.sin(λ2 - λ1) * Math.cos(φ2);\n  const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);\n  return Math.atan2(y, x);\n}\n","import { PSVError, utils } from 'photo-sphere-viewer';\nimport { AbstractDatasource } from './AbstractDatasource';\nimport { checkLink, checkNode } from './utils';\n\n/**\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @private\n */\nexport class ClientSideDatasource extends AbstractDatasource {\n\n  loadNode(nodeId) {\n    if (this.nodes[nodeId]) {\n      return Promise.resolve(this.nodes[nodeId]);\n    }\n    else {\n      return Promise.reject(new PSVError(`Node ${nodeId} not found`));\n    }\n  }\n\n  loadLinkedNodes(nodeId) {\n    if (!this.nodes[nodeId]) {\n      return Promise.reject(new PSVError(`Node ${nodeId} not found`));\n    }\n    else {\n      return Promise.resolve();\n    }\n  }\n\n  setNodes(rawNodes) {\n    if (!rawNodes?.length) {\n      throw new PSVError('No nodes provided');\n    }\n\n    const nodes = {};\n    const linkedNodes = {};\n\n    rawNodes.forEach((node) => {\n      checkNode(node, this.plugin.isGps());\n\n      if (nodes[node.id]) {\n        throw new PSVError(`Duplicate node ${node.id}`);\n      }\n      if (!node.links) {\n        utils.logWarn(`Node ${node.id} has no links`);\n        nodes.links = [];\n      }\n\n      nodes[node.id] = node;\n    });\n\n    rawNodes.forEach((node) => {\n      node.links.forEach((link) => {\n        checkLink(node, link, this.plugin.isGps());\n\n        if (!nodes[link.nodeId]) {\n          throw new PSVError(`Target node ${link.nodeId} of node ${node.id} does not exists`);\n        }\n\n        // copy essential data\n        link.position = link.position || nodes[link.nodeId].position;\n        link.name = link.name || nodes[link.nodeId].name;\n\n        linkedNodes[link.nodeId] = true;\n      });\n    });\n\n    rawNodes.forEach((node) => {\n      if (!linkedNodes[node.id]) {\n        utils.logWarn(`Node ${node.id} is never linked to`);\n      }\n    });\n\n    this.nodes = nodes;\n  }\n\n}\n","import { ObjectLoader } from 'three';\nimport arrowGeometryJson from './arrow.json';\nimport arrowIconSvg from './arrow.svg';\nimport arrowOutlineGeometryJson from './arrow_outline.json';\nimport nodesList from './nodes-list.svg';\n\n/**\n * @summary In client mode all the nodes are provided in the config or with the `setNodes` method\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_CLIENT = 'client';\n\n/**\n * @summary In server mode the nodes are fetched asynchronously\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_SERVER = 'server';\n\n/**\n * @summary In manual mode each link is positionned manually on the panorama\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_MANUAL = 'manual';\n\n/**\n * @summary In GPS mode each node is globally positionned and the links are automatically computed\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_GPS = 'gps';\n\n/**\n * @summaru In markers mode the links are represented using markers\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_MARKERS = 'markers';\n\n/**\n * @summaru In 3D mode the links are represented using 3d arrows\n * @type {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const MODE_3D = '3d';\n\n/**\n * @summary Available events\n * @enum {string}\n * @memberof PSV.plugins.VirtualTourPlugin\n * @constant\n */\nexport const EVENTS = {\n  /**\n   * @event node-changed\n   * @memberof PSV.plugins.VirtualTourPlugin\n   * @summary Triggered when the current node changes\n   * @param {string} nodeId\n   */\n  NODE_CHANGED     : 'node-changed',\n  /**\n   * @event filter:render-nodes-list\n   * @memberof PSV.plugins.VirtualTourPlugin\n   * @summary Used to alter the list of nodes displayed on the side-panel\n   * @param {PSV.plugins.VirtualTourPlugin.Node[]} nodes\n   * @returns {PSV.plugins.VirtualTourPlugin.Node[]}\n   */\n  RENDER_NODES_LIST: 'render-nodes-list',\n};\n\n/**\n * @summary Property name added to markers\n * @type {string}\n * @constant\n * @private\n */\nexport const LINK_DATA = 'tourLink';\n\n/**\n * @summary Default style of the link marker\n * @type {PSV.plugins.MarkersPlugin.Properties}\n * @constant\n * @private\n */\nexport const DEFAULT_MARKER = {\n  html     : arrowIconSvg,\n  width    : 80,\n  height   : 80,\n  scale    : [0.5, 2],\n  anchor   : 'top center',\n  className: 'psv-virtual-tour__marker',\n  style    : {\n    color: 'rgba(0, 208, 255, 0.8)',\n  },\n};\n\n/**\n * @summary Default style of the link arrow\n * @type {PSV.plugins.VirtualTourPlugin.ArrowStyle}\n * @constant\n * @private\n */\nexport const DEFAULT_ARROW = {\n  color       : 0xaaaaaa,\n  hoverColor  : 0xaa5500,\n  outlineColor: 0x000000,\n  scale       : [0.5, 2],\n};\n\n/**\n * @type {external:THREE.BufferedGeometry}\n * @constant\n * @private\n */\nexport const { ARROW_GEOM, ARROW_OUTLINE_GEOM } = (() => {\n  const loader = new ObjectLoader();\n  const geometries = loader.parseGeometries([arrowGeometryJson, arrowOutlineGeometryJson]);\n  const arrow = geometries[arrowGeometryJson.uuid];\n  const arrowOutline = geometries[arrowOutlineGeometryJson.uuid];\n  const scale = 0.015;\n  const rot = Math.PI / 2;\n  arrow.scale(scale, scale, scale);\n  arrow.rotateX(rot);\n  arrowOutline.scale(scale, scale, scale);\n  arrowOutline.rotateX(rot);\n  return { ARROW_GEOM: arrow, ARROW_OUTLINE_GEOM: arrowOutline };\n})();\n\n/**\n * @summary Panel identifier for nodes list\n * @type {string}\n * @constant\n * @private\n */\nexport const ID_PANEL_NODES_LIST = 'virtualTourNodesList';\n\n/**\n * @summary Nodes list template\n * @param {PSV.plugins.VirtualTourPlugin.Node[]} nodes\n * @param {string} title\n * @param {string} currentNodeId\n * @returns {string}\n * @constant\n * @private\n */\nexport const NODES_LIST_TEMPLATE = (nodes, title, currentNodeId) => `\n<div class=\"psv-panel-menu psv-panel-menu--stripped psv-virtual-tour__menu\">\n  <h1 class=\"psv-panel-menu-title\">${nodesList} ${title}</h1>\n  <ul class=\"psv-panel-menu-list\">\n    ${nodes.map(node => `\n    <li data-node-id=\"${node.id}\" tabindex=\"0\"\n        class=\"psv-panel-menu-item ${currentNodeId === node.id ? 'psv-panel-menu-item--active' : ''}\">\n      ${node.thumbnail ? `<span class=\"psv-panel-menu-item-icon\"><img src=\"${node.thumbnail}\"/></span>` : ''}\n      <span class=\"psv-panel-menu-item-label\">${node.caption || node.name}</span>\n    </li>\n    `).join('')}\n  </ul>\n</div>\n`;\n","import { AbstractButton, CONSTANTS } from '../..';\nimport { ID_PANEL_NODES_LIST } from './constants';\nimport nodesList from './nodes-list.svg';\n\n/**\n * @summary Navigation bar markers list button class\n * @extends PSV.buttons.AbstractButton\n * @memberof PSV.buttons\n */\nexport class NodesListButton extends AbstractButton {\n\n  static id = 'nodesList';\n  static icon = nodesList;\n\n  /**\n   * @param {PSV.components.Navbar} navbar\n   */\n  constructor(navbar) {\n    super(navbar, 'psv-button--hover-scale psv-nodes-list-button', true);\n\n    /**\n     * @type {PSV.plugins.VirtualTourPlugin}\n     */\n    this.plugin = this.psv.getPlugin('virtual-tour');\n\n    if (this.plugin) {\n      this.psv.on(CONSTANTS.EVENTS.OPEN_PANEL, this);\n      this.psv.on(CONSTANTS.EVENTS.CLOSE_PANEL, this);\n    }\n  }\n\n  /**\n   * @override\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.OPEN_PANEL, this);\n    this.psv.off(CONSTANTS.EVENTS.CLOSE_PANEL, this);\n\n    super.destroy();\n  }\n\n  /**\n   * @override\n   */\n  isSupported() {\n    return !!this.plugin && !this.plugin.isServerSide() && !this.plugin.gallery;\n  }\n\n  /**\n   * @summary Handles events\n   * @param {Event} e\n   * @private\n   */\n  handleEvent(e) {\n    /* eslint-disable */\n    switch (e.type) {\n      // @formatter:off\n      case CONSTANTS.EVENTS.OPEN_PANEL:  this.toggleActive(e.args[0] === ID_PANEL_NODES_LIST); break;\n      case CONSTANTS.EVENTS.CLOSE_PANEL: this.toggleActive(false); break;\n      // @formatter:on\n    }\n    /* eslint-enable */\n  }\n\n  /**\n   * @override\n   * @description Toggles nodes list\n   */\n  onClick() {\n    this.plugin.toggleNodesList();\n  }\n\n}\n","import { PSVError, utils } from 'photo-sphere-viewer';\nimport { AbstractDatasource } from './AbstractDatasource';\nimport { checkLink, checkNode } from './utils';\n\n/**\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @private\n */\nexport class ServerSideDatasource extends AbstractDatasource {\n\n  constructor(plugin) {\n    super(plugin);\n\n    if (!plugin.config.getNode) {\n      throw new PSVError('Missing getNode() option.');\n    }\n\n    this.nodeResolver = plugin.config.getNode;\n    this.linksResolver = plugin.config.getLinks;\n  }\n\n  loadNode(nodeId) {\n    if (this.nodes[nodeId]) {\n      return Promise.resolve(this.nodes[nodeId]);\n    }\n    else {\n      return Promise.resolve(this.nodeResolver(nodeId))\n        .then((node) => {\n          checkNode(node, this.plugin.isGps());\n          this.nodes[nodeId] = node;\n          return node;\n        });\n    }\n  }\n\n  loadLinkedNodes(nodeId) {\n    if (!this.nodes[nodeId]) {\n      return Promise.reject(new PSVError(`Node ${nodeId} not found`));\n    }\n    else if (this.nodes[nodeId].links) {\n      return Promise.resolve();\n    }\n    else {\n      if (!this.linksResolver) {\n        this.nodes[nodeId].links = [];\n        return Promise.resolve();\n      }\n\n      utils.logWarn(`getLinks() option is deprecated, instead make getNode() also return the node' links.`);\n\n      return Promise.resolve(this.linksResolver(nodeId))\n        .then(links => links || [])\n        .then((links) => {\n          const node = this.nodes[nodeId];\n\n          links.forEach((link) => {\n            checkLink(node, link, this.plugin.isGps());\n\n            // copy essential data\n            if (this.nodes[link.nodeId]) {\n              link.position = link.position || this.nodes[link.nodeId].position;\n              link.name = link.name || this.nodes[link.nodeId].name;\n            }\n\n            if (this.plugin.isGps() && !link.position) {\n              throw new PSVError(`No GPS position provided for link ${link.nodeId} of node ${node.id}`);\n            }\n          });\n\n          // store links\n          node.links = links;\n        });\n    }\n  }\n\n}\n","import {\n  AmbientLight,\n  BackSide,\n  Group,\n  MathUtils,\n  Mesh,\n  MeshBasicMaterial,\n  MeshLambertMaterial,\n  PointLight\n} from 'three';\nimport { AbstractPlugin, CONSTANTS, DEFAULTS, PSVError, registerButton, utils } from '../..';\nimport { ClientSideDatasource } from './ClientSideDatasource';\nimport {\n  ARROW_GEOM,\n  ARROW_OUTLINE_GEOM,\n  DEFAULT_ARROW,\n  DEFAULT_MARKER,\n  EVENTS,\n  ID_PANEL_NODES_LIST,\n  LINK_DATA,\n  MODE_3D,\n  MODE_CLIENT,\n  MODE_GPS,\n  MODE_MANUAL,\n  MODE_MARKERS,\n  MODE_SERVER,\n  NODES_LIST_TEMPLATE\n} from './constants';\nimport { NodesListButton } from './NodesListButton';\nimport { ServerSideDatasource } from './ServerSideDatasource';\nimport './style.scss';\nimport { bearing, distance, setMeshColor } from './utils';\n\n\n/**\n * @callback GetNode\n * @summary Function to load a node\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @param {string} nodeId\n * @returns {PSV.plugins.VirtualTourPlugin.Node|Promise<PSV.plugins.VirtualTourPlugin.Node>}\n */\n\n/**\n * @callback GetLinks\n * @summary Function to load the links of a node\n * @deprecated `getNode` must directly return the links of each node\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @param {string} nodeId\n * @returns {PSV.plugins.VirtualTourPlugin.NodeLink[]|Promise<PSV.plugins.VirtualTourPlugin.NodeLink[]>}\n */\n\n/**\n * @callback Preload\n * @summary Function to determine if a link must be preloaded\n * @memberOf PSV.plugins.VirtualTourPlugin\n * @param {PSV.plugins.VirtualTourPlugin.Node} node\n * @param {PSV.plugins.VirtualTourPlugin.NodeLink} link\n * @returns {boolean}\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.Node\n * @summary Definition of a single node in the tour\n * @property {string} id - unique identifier of the node\n * @property {*} panorama\n * @property {PSV.plugins.VirtualTourPlugin.NodeLink[]} [links] - links to other nodes\n * @property {number[]} [position] - GPS position (longitude, latitude, optional altitude)\n * @property {PSV.PanoData | PSV.PanoDataProvider} [panoData] - data used for this panorama\n * @property {PSV.SphereCorrection} [sphereCorrection] - sphere correction to apply to this panorama\n * @property {string} [name] - short name of the node\n * @property {string} [caption] - caption visible in the navbar\n * @property {string} [description] - description visible in the side panel\n * @property {string} [thumbnail] - thumbnail for the nodes list in the side panel\n * @property {PSV.plugins.MarkersPlugin.Properties[]} [markers] - additional markers to use on this node\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.VirtualTourPlugin.NodeLink\n * @summary Definition of a link between two nodes\n * @property {string} nodeId - identifier of the target node\n * @property {string} [name] - override the name of the node (tooltip)\n * @property {number[]} [position] - override the GPS position of the node\n * @property {PSV.plugins.MarkersPlugin.Properties} [markerStyle] - override global marker style\n * @property {PSV.plugins.VirtualTourPlugin.ArrowStyle} [arrowStyle] - override global arrow style\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.ArrowStyle\n * @summary Style of the arrow in 3D mode\n * @property {string} [color=0xaaaaaa]\n * @property {string} [hoverColor=0xaa5500]\n * @property {number} [outlineColor=0x000000]\n * @property {number[]} [scale=[0.5,2]]\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.Options\n * @property {'client'|'server'} [dataMode='client'] - configure data mode\n * @property {'manual'|'gps'} [positionMode='manual'] - configure positioning mode\n * @property {'markers'|'3d'} [renderMode='3d'] - configure rendering mode of links\n * @property {PSV.plugins.VirtualTourPlugin.Node[]} [nodes] - initial nodes\n * @property {PSV.plugins.VirtualTourPlugin.GetNode} [getNode]\n * @property {PSV.plugins.VirtualTourPlugin.GetLinks} [getLinks] - Deprecated: `getNode` must directly return the links of each node\n * @property {string} [startNodeId] - id of the initial node, if not defined the first node will be used\n * @property {boolean|PSV.plugins.VirtualTourPlugin.Preload} [preload=false] - preload linked panoramas\n * @property {boolean|string|number} [rotateSpeed='20rpm'] - speed of rotation when clicking on a link, if 'false' the viewer won't rotate at all\n * @property {boolean|number} [transition=1500] - duration of the transition between nodes\n * @property {boolean} [linksOnCompass] - if the Compass plugin is enabled, displays the links on the compass, defaults to `true` on in markers render mode\n * @property {PSV.plugins.MarkersPlugin.Properties} [markerStyle] - global marker style\n * @property {PSV.plugins.VirtualTourPlugin.ArrowStyle} [arrowStyle] - global arrow style\n * @property {number} [markerLatOffset=-0.1] - (GPS & Markers mode) latitude offset applied to link markers, to compensate for viewer height\n * @property {'top'|'bottom'} [arrowPosition='bottom'] - (3D mode) arrows vertical position\n */\n\n/**\n * @typedef {Object} PSV.plugins.VirtualTourPlugin.NodeChangedData\n * @summary Data associated to the \"node-changed\" event\n * @type {PSV.plugins.VirtualTourPlugin.Node} [fromNode] - The previous node\n * @type {PSV.plugins.VirtualTourPlugin.NodeLink} [fromLink] - The link that was clicked in the previous node\n * @type {PSV.Position} [fromLinkPosition] - The position of the link on the previous node\n */\n\n// add markers buttons\nDEFAULTS.lang[NodesListButton.id] = 'Locations';\nregisterButton(NodesListButton, 'caption:left');\n\n\nexport { EVENTS, MODE_3D, MODE_CLIENT, MODE_GPS, MODE_MANUAL, MODE_MARKERS, MODE_SERVER } from './constants';\n\n\n/**\n * @summary Create virtual tours by linking multiple panoramas\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class VirtualTourPlugin extends AbstractPlugin {\n\n  static id = 'virtual-tour';\n\n  static EVENTS = EVENTS;\n  static MODE_CLIENT = MODE_CLIENT;\n  static MODE_SERVER = MODE_SERVER;\n  static MODE_3D = MODE_3D;\n  static MODE_MARKERS = MODE_MARKERS;\n  static MODE_MANUAL = MODE_MANUAL;\n  static MODE_GPS = MODE_GPS;\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.VirtualTourPlugin.Options} [options]\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {Object}\n     * @property {PSV.plugins.VirtualTourPlugin.Node} currentNode\n     * @property {PSV.Tooltip} currentTooltip\n     * @property {string} loadingNode\n     * @property {function} stopObserver\n     * @private\n     */\n    this.prop = {\n      currentNode   : null,\n      currentTooltip: null,\n      loadingNode   : null,\n      stopObserver  : null,\n    };\n\n    /**\n     * @type {Record<string, boolean | Promise>}\n     * @private\n     */\n    this.preload = {};\n\n    /**\n     * @member {PSV.plugins.VirtualTourPlugin.Options}\n     * @private\n     */\n    this.config = {\n      dataMode       : MODE_CLIENT,\n      positionMode   : MODE_MANUAL,\n      renderMode     : MODE_3D,\n      preload        : false,\n      rotateSpeed    : '20rpm',\n      transition     : CONSTANTS.DEFAULT_TRANSITION,\n      markerLatOffset: -0.1,\n      arrowPosition  : 'bottom',\n      linksOnCompass : options?.renderMode === MODE_MARKERS,\n      ...options,\n      markerStyle    : {\n        ...DEFAULT_MARKER,\n        ...options?.markerStyle,\n      },\n      arrowStyle     : {\n        ...DEFAULT_ARROW,\n        ...options?.arrowStyle,\n      },\n    };\n\n    if (options?.listButton === false) {\n      utils.logWarn('VirtualTourPlugin: listButton option is deprecated. '\n        + 'Please define the global navbar options according to your needs.');\n    }\n    if (options?.listButton === true && this.config.dataMode === MODE_SERVER) {\n      utils.logWarn('VirtualTourPlugin: the list button is not supported in server mode.');\n    }\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n\n    /**\n     * @type {PSV.plugins.CompassPlugin}\n     * @private\n     */\n    this.compass = null;\n\n    /**\n     * @type {PSV.plugins.GalleryPlugin}\n     * @private\n     */\n    this.gallery = null;\n\n    /**\n     * @type {PSV.plugins.VirtualTourPlugin.AbstractDatasource}\n     */\n    this.datasource = null;\n\n    /**\n     * @type {external:THREE.Group}\n     * @private\n     */\n    this.arrowsGroup = null;\n\n    if (this.is3D()) {\n      this.arrowsGroup = new Group();\n\n      const localLight = new PointLight(0xffffff, 1, 0);\n      localLight.position.set(0, this.config.arrowPosition === 'bottom' ? 2 : -2, 0);\n      this.arrowsGroup.add(localLight);\n    }\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n    this.compass = this.psv.getPlugin('compass');\n    this.gallery = this.psv.getPlugin('gallery');\n\n    if (!this.is3D() && !this.markers) {\n      throw new PSVError('VirtualTour plugin requires the Markers plugin in markers mode.');\n    }\n\n    if (this.markers?.config.markers) {\n      utils.logWarn('No default markers can be configured on Markers plugin when using VirtualTour plugin. '\n        + 'Consider defining `markers` on each tour node.');\n      delete this.markers.config.markers;\n    }\n\n    this.datasource = this.isServerSide() ? new ServerSideDatasource(this) : new ClientSideDatasource(this);\n\n    if (this.is3D()) {\n      this.psv.once(CONSTANTS.EVENTS.READY, () => {\n        this.__positionArrows();\n        this.psv.renderer.scene.add(this.arrowsGroup);\n\n        const ambientLight = new AmbientLight(0xffffff, 1);\n        this.psv.renderer.scene.add(ambientLight);\n\n        this.psv.needsUpdate();\n      });\n\n      this.psv.on(CONSTANTS.EVENTS.POSITION_UPDATED, this);\n      this.psv.on(CONSTANTS.EVENTS.ZOOM_UPDATED, this);\n      this.psv.on(CONSTANTS.EVENTS.CLICK, this);\n      this.prop.stopObserver = this.psv.observeObjects(LINK_DATA, this);\n    }\n    else {\n      this.markers.on('select-marker', this);\n    }\n\n    if (this.isServerSide()) {\n      if (this.config.startNodeId) {\n        this.setCurrentNode(this.config.startNodeId);\n      }\n    }\n    else if (this.config.nodes) {\n      this.setNodes(this.config.nodes, this.config.startNodeId);\n      delete this.config.nodes;\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    if (this.markers) {\n      this.markers.off('select-marker', this);\n    }\n    if (this.arrowsGroup) {\n      this.psv.renderer.scene.remove(this.arrowsGroup);\n    }\n\n    this.psv.off(CONSTANTS.EVENTS.POSITION_UPDATED, this);\n    this.psv.off(CONSTANTS.EVENTS.ZOOM_UPDATED, this);\n    this.psv.off(CONSTANTS.EVENTS.CLICK, this);\n    this.prop.stopObserver?.();\n\n    this.datasource.destroy();\n\n    delete this.preload;\n    delete this.datasource;\n    delete this.markers;\n    delete this.compass;\n    delete this.gallery;\n    delete this.arrowsGroup;\n\n    super.destroy();\n  }\n\n  handleEvent(e) {\n    let link;\n    switch (e.type) {\n      case 'select-marker':\n        link = e.args[0].data?.[LINK_DATA];\n        if (link) {\n          this.setCurrentNode(link.nodeId, link);\n        }\n        break;\n\n      case CONSTANTS.EVENTS.POSITION_UPDATED:\n      case CONSTANTS.EVENTS.ZOOM_UPDATED:\n        if (this.arrowsGroup) {\n          this.__positionArrows();\n        }\n        break;\n\n      case CONSTANTS.EVENTS.CLICK:\n        link = e.args[0].objects.find(o => o.userData[LINK_DATA])?.userData[LINK_DATA];\n        if (link) {\n          this.setCurrentNode(link.nodeId, link);\n        }\n        break;\n\n      case CONSTANTS.OBJECT_EVENTS.ENTER_OBJECT:\n        this.__onEnterObject(e.detail.object, e.detail.viewerPoint);\n        break;\n      case CONSTANTS.OBJECT_EVENTS.HOVER_OBJECT:\n        this.__onHoverObject(e.detail.object, e.detail.viewerPoint);\n        break;\n      case CONSTANTS.OBJECT_EVENTS.LEAVE_OBJECT:\n        this.__onLeaveObject(e.detail.object);\n        break;\n\n      default:\n    }\n  }\n\n  /**\n   * @summary Tests if running in server mode\n   * @return {boolean}\n   */\n  isServerSide() {\n    return this.config.dataMode === MODE_SERVER;\n  }\n\n  /**\n   * @summary Tests if running in GPS mode\n   * @return {boolean}\n   */\n  isGps() {\n    return this.config.positionMode === MODE_GPS;\n  }\n\n  /**\n   * @summary Tests if running in 3D mode\n   * @return {boolean}\n   */\n  is3D() {\n    return this.config.renderMode === MODE_3D;\n  }\n\n  /**\n   * @summary Sets the nodes (client mode only)\n   * @param {PSV.plugins.VirtualTourPlugin.Node[]} nodes\n   * @param {string} [startNodeId]\n   * @throws {PSV.PSVError} when the configuration is incorrect\n   */\n  setNodes(nodes, startNodeId) {\n    if (this.isServerSide()) {\n      throw new PSVError('Cannot set nodes in server side mode');\n    }\n\n    this.datasource.setNodes(nodes);\n\n    if (!startNodeId) {\n      startNodeId = nodes[0].id;\n    }\n    else if (!this.datasource.nodes[startNodeId]) {\n      startNodeId = nodes[0].id;\n      utils.logWarn(`startNodeId not found is provided nodes, resetted to ${startNodeId}`);\n    }\n\n    this.setCurrentNode(startNodeId);\n\n    if (this.gallery) {\n      this.gallery.setItems(\n        nodes.map(node => ({\n          id       : node.id,\n          panorama : node.panorama,\n          name     : node.name,\n          thumbnail: node.thumbnail,\n          options  : {\n            caption         : node.caption,\n            panoData        : node.panoData,\n            sphereCorrection: node.sphereCorrection,\n            description     : node.description,\n          },\n        })),\n        (id) => {\n          this.setCurrentNode(id);\n          this.gallery.hide();\n        }\n      );\n    }\n  }\n\n  /**\n   * @summary Changes the current node\n   * @param {string} nodeId\n   * @param {PSV.plugins.VirtualTourPlugin.NodeLink} [fromLink]\n   * @returns {Promise<boolean>} resolves false if the loading was aborted by another call\n   */\n  setCurrentNode(nodeId, fromLink = null) {\n    if (nodeId === this.prop.currentNode?.id) {\n      return Promise.resolve(true);\n    }\n\n    this.psv.hideError();\n\n    this.prop.loadingNode = nodeId;\n\n    const fromNode = this.prop.currentNode;\n    const fromLinkPosition = fromNode && fromLink ? this.__getLinkPosition(fromNode, fromLink) : null;\n\n    return Promise.all([\n      // if this node is already preloading, wait for it\n      Promise.resolve(this.preload[nodeId])\n        .then(() => {\n          if (this.prop.loadingNode !== nodeId) {\n            throw utils.getAbortError();\n          }\n\n          return this.datasource.loadNode(nodeId);\n        }),\n      Promise.resolve(fromLinkPosition ? this.config.rotateSpeed : false)\n        .then((speed) => { // eslint-disable-line consistent-return\n          if (speed) {\n            return this.psv.animate({ ...fromLinkPosition, speed });\n          }\n        })\n        .then(() => {\n          this.psv.loader.show();\n        }),\n    ])\n      .then(([node]) => {\n        if (this.prop.loadingNode !== nodeId) {\n          throw utils.getAbortError();\n        }\n\n        this.prop.currentNode = node;\n\n        if (this.prop.currentTooltip) {\n          this.prop.currentTooltip.hide();\n          this.prop.currentTooltip = null;\n        }\n\n        if (this.is3D()) {\n          this.arrowsGroup.remove(...this.arrowsGroup.children.filter(o => o.type === 'Mesh'));\n        }\n\n        this.markers?.clearMarkers();\n        this.compass?.clearHotspots();\n\n        return Promise.all([\n          this.psv.setPanorama(node.panorama, {\n            transition      : this.config.transition,\n            caption         : node.caption,\n            description     : node.description,\n            panoData        : node.panoData,\n            sphereCorrection: node.sphereCorrection,\n          })\n            .then((completed) => {\n              if (!completed) {\n                throw utils.getAbortError();\n              }\n            }),\n          this.datasource.loadLinkedNodes(nodeId),\n        ]);\n      })\n      .then(() => {\n        if (this.prop.loadingNode !== nodeId) {\n          throw utils.getAbortError();\n        }\n\n        const node = this.prop.currentNode;\n\n        if (node.markers) {\n          if (this.markers) {\n            this.markers.setMarkers(node.markers);\n          }\n          else {\n            utils.logWarn(`Node ${node.id} markers ignored because the plugin is not loaded.`);\n          }\n        }\n\n        this.__renderLinks(node);\n        this.__preload(node);\n\n        /**\n         * @event node-changed\n         * @memberof PSV.plugins.VirtualTourPlugin\n         * @summary Triggered when the current node is changed\n         * @param {string} nodeId\n         * @param {PSV.plugins.VirtualTourPlugin.NodeChangedData} data\n         */\n        this.trigger(EVENTS.NODE_CHANGED, nodeId, {\n          fromNode,\n          fromLink,\n          fromLinkPosition,\n        });\n\n        this.prop.loadingNode = null;\n\n        return true;\n      })\n      .catch((err) => {\n        if (utils.isAbortError(err)) {\n          return false;\n        }\n\n        this.psv.showError(this.psv.config.lang.loadError);\n\n        this.psv.loader.hide();\n        this.psv.navbar.setCaption('');\n\n        this.prop.loadingNode = null;\n\n        throw err;\n      });\n  }\n\n  /**\n   * @summary Adds the links for the node\n   * @param {PSV.plugins.VirtualTourPlugin.Node} node\n   * @private\n   */\n  __renderLinks(node) {\n    const positions = [];\n\n    node.links.forEach((link) => {\n      const position = this.__getLinkPosition(node, link);\n      positions.push(position);\n\n      if (this.is3D()) {\n        const mesh = new Mesh(ARROW_GEOM, new MeshLambertMaterial());\n        mesh.userData = { [LINK_DATA]: link, longitude: position.longitude };\n        mesh.rotation.order = 'YXZ';\n        mesh.rotateY(-position.longitude);\n        this.psv.dataHelper\n          .sphericalCoordsToVector3({ longitude: position.longitude, latitude: 0 }, mesh.position)\n          .multiplyScalar(1 / CONSTANTS.SPHERE_RADIUS);\n\n        const outlineMesh = new Mesh(ARROW_OUTLINE_GEOM, new MeshBasicMaterial({ side: BackSide }));\n        outlineMesh.position.copy(mesh.position);\n        outlineMesh.rotation.copy(mesh.rotation);\n\n        setMeshColor(mesh, link.arrowStyle?.color || this.config.arrowStyle.color);\n        setMeshColor(outlineMesh, link.arrowStyle?.outlineColor || this.config.arrowStyle.outlineColor);\n\n        this.arrowsGroup.add(mesh);\n        this.arrowsGroup.add(outlineMesh);\n      }\n      else {\n        if (this.isGps()) {\n          position.latitude += this.config.markerLatOffset;\n        }\n\n        this.markers.addMarker({\n          ...this.config.markerStyle,\n          ...link.markerStyle,\n          id      : `tour-link-${link.nodeId}`,\n          tooltip : link.name,\n          visible : true,\n          hideList: true,\n          content : null,\n          data    : { [LINK_DATA]: link },\n          ...position,\n        }, false);\n      }\n    });\n\n    if (this.is3D()) {\n      this.__positionArrows();\n    }\n    else {\n      this.markers.renderMarkers();\n    }\n\n    if (this.config.linksOnCompass && this.compass) {\n      this.compass.setHotspots(positions);\n    }\n  }\n\n  /**\n   * @summary Computes the marker position for a link\n   * @param {PSV.plugins.VirtualTourPlugin.Node} node\n   * @param {PSV.plugins.VirtualTourPlugin.NodeLink} link\n   * @return {PSV.Position}\n   * @private\n   */\n  __getLinkPosition(node, link) {\n    if (this.isGps()) {\n      const p1 = [MathUtils.degToRad(node.position[0]), MathUtils.degToRad(node.position[1])];\n      const p2 = [MathUtils.degToRad(link.position[0]), MathUtils.degToRad(link.position[1])];\n      const h1 = node.position[2] !== undefined ? node.position[2] : link.position[2] || 0;\n      const h2 = link.position[2] !== undefined ? link.position[2] : node.position[2] || 0;\n\n      let latitude = 0;\n      if (h1 !== h2) {\n        latitude = Math.atan((h2 - h1) / distance(p1, p2));\n      }\n\n      const longitude = bearing(p1, p2);\n\n      return { longitude, latitude };\n    }\n    else {\n      return this.psv.dataHelper.cleanPosition(link);\n    }\n  }\n\n  /**\n   * @private\n   */\n  __onEnterObject(mesh, viewerPoint) {\n    const link = mesh.userData[LINK_DATA];\n\n    setMeshColor(mesh, link.arrowStyle?.hoverColor || this.config.arrowStyle.hoverColor);\n\n    if (link.name) {\n      this.prop.currentTooltip = this.psv.tooltip.create({\n        left   : viewerPoint.x,\n        top    : viewerPoint.y,\n        content: link.name,\n      });\n    }\n\n    this.psv.needsUpdate();\n  }\n\n\n  /**\n   * @private\n   */\n  __onHoverObject(mesh, viewerPoint) {\n    if (this.prop.currentTooltip) {\n      this.prop.currentTooltip.move({\n        left: viewerPoint.x,\n        top : viewerPoint.y,\n      });\n    }\n  }\n\n\n  /**\n   * @private\n   */\n  __onLeaveObject(mesh) {\n    const link = mesh.userData[LINK_DATA];\n\n    setMeshColor(mesh, link.arrowStyle?.color || this.config.arrowStyle.color);\n\n    if (this.prop.currentTooltip) {\n      this.prop.currentTooltip.hide();\n      this.prop.currentTooltip = null;\n    }\n\n    this.psv.needsUpdate();\n  }\n\n  /**\n   * @summary Updates to position of the group of arrows\n   * @private\n   */\n  __positionArrows() {\n    this.arrowsGroup.position.copy(this.psv.prop.direction).multiplyScalar(0.5);\n    const s = this.config.arrowStyle.scale;\n    const f = s[1] + (s[0] - s[1]) * (this.psv.getZoomLevel() / 100);\n    const y = 2.5 - (this.psv.getZoomLevel() / 100) * 1.5;\n    this.arrowsGroup.position.y += this.config.arrowPosition === 'bottom' ? -y : y;\n    this.arrowsGroup.scale.set(f, f, f);\n  }\n\n  /**\n   * @summary Manage the preload of the linked panoramas\n   * @param {PSV.plugins.VirtualTourPlugin.Node} node\n   * @private\n   */\n  __preload(node) {\n    if (!this.config.preload) {\n      return;\n    }\n\n    this.preload[node.id] = true;\n\n    this.prop.currentNode.links\n      .filter(link => !this.preload[link.nodeId])\n      .filter((link) => {\n        if (typeof this.config.preload === 'function') {\n          return this.config.preload(this.prop.currentNode, link);\n        }\n        else {\n          return true;\n        }\n      })\n      .forEach((link) => {\n        this.preload[link.nodeId] = this.datasource.loadNode(link.nodeId)\n          .then((linkNode) => {\n            return this.psv.textureLoader.preloadPanorama(linkNode.panorama);\n          })\n          .then(() => {\n            this.preload[link.nodeId] = true;\n          })\n          .catch(() => {\n            delete this.preload[link.nodeId];\n          });\n      });\n  }\n\n  /**\n   * @summary Toggles the visibility of the list of nodes\n   */\n  toggleNodesList() {\n    if (this.psv.panel.prop.contentId === ID_PANEL_NODES_LIST) {\n      this.hideNodesList();\n    }\n    else {\n      this.showNodesList();\n    }\n  }\n\n  /**\n   * @summary Opens side panel with the list of nodes\n   */\n  showNodesList() {\n    utils.logWarn(`Starting from next version, the VirtualTourPlugin will require the GalleryPlugin to display the list of nodes.`);\n\n    const nodes = this.change(EVENTS.RENDER_NODES_LIST, Object.values(this.datasource.nodes));\n\n    this.psv.panel.show({\n      id          : ID_PANEL_NODES_LIST,\n      content     : NODES_LIST_TEMPLATE(\n        nodes,\n        this.psv.config.lang[NodesListButton.id],\n        this.prop.currentNode?.id\n      ),\n      noMargin    : true,\n      clickHandler: (e) => {\n        const li = e.target ? utils.getClosest(e.target, 'li') : undefined;\n        const nodeId = li ? li.dataset.nodeId : undefined;\n\n        if (nodeId) {\n          this.setCurrentNode(nodeId);\n          this.hideNodesList();\n        }\n      },\n    });\n  }\n\n  /**\n   * @summary Closes side panel if it contains the list of nodes\n   */\n  hideNodesList() {\n    this.psv.panel.hide(ID_PANEL_NODES_LIST);\n  }\n\n}\n"],"names":["AbstractDatasource","plugin","nodes","destroy","loadNode","nodeId","PSVError","loadLinkedNodes","checkNode","node","isGps","id","panorama","position","length","checkLink","link","utils","isExtendedPosition","setMeshColor","mesh","color","material","set","distance","p1","p2","greatArcDistance","bearing","λ1","φ1","λ2","φ2","y","Math","sin","cos","x","atan2","ClientSideDatasource","Promise","resolve","reject","setNodes","rawNodes","linkedNodes","forEach","links","logWarn","name","MODE_CLIENT","MODE_SERVER","MODE_MANUAL","MODE_GPS","MODE_MARKERS","MODE_3D","EVENTS","NODE_CHANGED","RENDER_NODES_LIST","LINK_DATA","DEFAULT_MARKER","html","arrowIconSvg","width","height","scale","anchor","className","style","DEFAULT_ARROW","hoverColor","outlineColor","loader","ObjectLoader","geometries","parseGeometries","arrowGeometryJson","arrowOutlineGeometryJson","arrow","uuid","arrowOutline","rot","PI","rotateX","ARROW_GEOM","ARROW_OUTLINE_GEOM","ID_PANEL_NODES_LIST","NODES_LIST_TEMPLATE","title","currentNodeId","nodesList","map","thumbnail","caption","join","NodesListButton","navbar","psv","getPlugin","on","CONSTANTS","OPEN_PANEL","CLOSE_PANEL","off","isSupported","isServerSide","gallery","handleEvent","e","type","toggleActive","args","onClick","toggleNodesList","AbstractButton","icon","ServerSideDatasource","config","getNode","nodeResolver","linksResolver","getLinks","then","DEFAULTS","lang","registerButton","VirtualTourPlugin","options","prop","currentNode","currentTooltip","loadingNode","stopObserver","preload","dataMode","positionMode","renderMode","rotateSpeed","transition","DEFAULT_TRANSITION","markerLatOffset","arrowPosition","linksOnCompass","markerStyle","arrowStyle","listButton","markers","compass","datasource","arrowsGroup","is3D","Group","localLight","PointLight","add","init","once","READY","__positionArrows","renderer","scene","ambientLight","AmbientLight","needsUpdate","POSITION_UPDATED","ZOOM_UPDATED","CLICK","observeObjects","startNodeId","setCurrentNode","remove","data","objects","find","o","userData","OBJECT_EVENTS","ENTER_OBJECT","__onEnterObject","detail","object","viewerPoint","HOVER_OBJECT","__onHoverObject","LEAVE_OBJECT","__onLeaveObject","setItems","panoData","sphereCorrection","description","hide","fromLink","hideError","fromNode","fromLinkPosition","__getLinkPosition","all","getAbortError","speed","animate","show","children","filter","clearMarkers","clearHotspots","setPanorama","completed","setMarkers","__renderLinks","__preload","trigger","catch","err","isAbortError","showError","loadError","setCaption","positions","push","Mesh","MeshLambertMaterial","longitude","rotation","order","rotateY","dataHelper","sphericalCoordsToVector3","latitude","multiplyScalar","SPHERE_RADIUS","outlineMesh","MeshBasicMaterial","side","BackSide","copy","addMarker","tooltip","visible","hideList","content","renderMarkers","setHotspots","MathUtils","degToRad","h1","undefined","h2","atan","cleanPosition","create","left","top","move","direction","s","f","getZoomLevel","linkNode","textureLoader","preloadPanorama","panel","contentId","hideNodesList","showNodesList","change","Object","values","noMargin","clickHandler","li","target","getClosest","dataset","AbstractPlugin"],"mappings":"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,CAAChD,MAAL,CAAYS,KAAZ,MAAuB,CAACM,IAAI,CAACH,QAAjC,EAA2C;EACzC,kBAAM,IAAIP,0BAAJ,wCAAkDU,IAAI,CAACX,MAAvD,iBAAyEI,IAAI,CAACE,EAA9E,CAAN;EACD;EACF,SAZD,EAHe;;EAkBfF,QAAAA,IAAI,CAACsC,KAAL,GAAaA,KAAb;EACD,OArBI,CAAP;EAsBD;EACF,GAjEH;;EAAA;EAAA,EAA0C/C,kBAA1C;;EC0BA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EAEA;;AACA2H,4BAAQ,CAACC,IAAT,CAAc7B,eAAe,CAACpF,EAA9B,IAAoC,WAApC;AACAkH,kCAAc,CAAC9B,eAAD,EAAkB,cAAlB,CAAd;EAMA;EACA;EACA;EACA;EACA;;MACa+B,iBAAb;EAAA;;EAYE;EACF;EACA;EACA;EACE,6BAAY7B,GAAZ,EAAiB8B,OAAjB,EAA0B;EAAA;;EACxB,uCAAM9B,GAAN;EAEA;EACJ;EACA;EACA;EACA;EACA;EACA;EACA;;EACI,UAAK+B,IAAL,GAAY;EACVC,MAAAA,WAAW,EAAK,IADN;EAEVC,MAAAA,cAAc,EAAE,IAFN;EAGVC,MAAAA,WAAW,EAAK,IAHN;EAIVC,MAAAA,YAAY,EAAI;EAJN,KAAZ;EAOA;EACJ;EACA;EACA;;EACI,UAAKC,OAAL,GAAe,EAAf;EAEA;EACJ;EACA;EACA;;EACI,UAAKhB,MAAL;EACEiB,MAAAA,QAAQ,EAASpF,WADnB;EAE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"}