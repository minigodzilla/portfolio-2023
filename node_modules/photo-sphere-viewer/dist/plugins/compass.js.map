{"version":3,"file":"compass.js","sources":["../../src/plugins/compass/index.js"],"sourcesContent":["import { MathUtils } from 'three';\nimport { AbstractPlugin, CONSTANTS, SYSTEM, utils } from '../..';\nimport compass from './compass.svg';\nimport './style.scss';\n\n\n/**\n * @typedef {Object} PSV.plugins.CompassPlugin.Options\n * @property {string} [size='120px'] - size of the compass\n * @property {string} [position='top left'] - position of the compass\n * @property {string} [backgroundSvg] - SVG used as background of the compass\n * @property {string} [coneColor='rgba(255, 255, 255, 0.5)'] - color of the cone of the compass\n * @property {boolean} [navigation=true] - allows to click on the compass to rotate the viewer\n * @property {string} [navigationColor='rgba(255, 0, 0, 0.2)'] - color of the navigation cone\n * @property {PSV.plugins.CompassPlugin.Hotspot[]} [hotspots] - small dots visible on the compass (will contain every marker with the \"compass\" data)\n * @property {string} [hotspotColor='rgba(0, 0, 0, 0.5)'] - default color of hotspots\n */\n\n/**\n * @typedef {PSV.ExtendedPosition} PSV.plugins.CompassPlugin.Hotspot\n * @type {string} [color] - override the global \"hotspotColor\"\n */\n\n\nconst HOTSPOT_SIZE_RATIO = 1 / 40;\n\n\n/**\n * @summary Adds a compass on the viewer\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class CompassPlugin extends AbstractPlugin {\n\n  static id = 'compass';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.CompassPlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {PSV.plugins.CompassPlugin.Options}\n     * @private\n     */\n    this.config = {\n      size           : '120px',\n      position       : 'top left',\n      backgroundSvg  : compass,\n      coneColor      : 'rgba(255, 255, 255, 0.5)',\n      navigation     : true,\n      navigationColor: 'rgba(255, 0, 0, 0.2)',\n      hotspotColor   : 'rgba(0, 0, 0, 0.5)',\n      ...options,\n    };\n    this.config.position = utils.cleanPosition(this.config.position, 'top left');\n\n    /**\n     * @private\n     */\n    this.prop = {\n      visible  : true,\n      mouse    : null,\n      mouseDown: false,\n      markers  : [],\n    };\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n\n    /**\n     * @member {HTMLElement}\n     * @readonly\n     * @private\n     */\n    this.container = document.createElement('div');\n    this.container.className = `psv-compass psv-compass--${this.config.position.join('-')}`;\n    this.container.innerHTML = this.config.backgroundSvg;\n\n    this.container.style.width = this.config.size;\n    this.container.style.height = this.config.size;\n    if (this.config.position[0] === 'center') {\n      this.container.style.marginTop = `calc(-${this.config.size} / 2)`;\n    }\n    if (this.config.position[1] === 'center') {\n      this.container.style.marginLeft = `calc(-${this.config.size} / 2)`;\n    }\n\n    /**\n     * @member {HTMLCanvasElement}\n     * @readonly\n     * @private\n     */\n    this.canvas = document.createElement('canvas');\n\n    this.container.appendChild(this.canvas);\n\n    if (this.config.navigation) {\n      this.container.addEventListener('mouseenter', this);\n      this.container.addEventListener('mouseleave', this);\n      this.container.addEventListener('mousemove', this);\n      this.container.addEventListener('mousedown', this);\n      this.container.addEventListener('mouseup', this);\n      this.container.addEventListener('touchstart', this);\n      this.container.addEventListener('touchmove', this);\n      this.container.addEventListener('touchend', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n\n    this.psv.container.appendChild(this.container);\n\n    this.canvas.width = this.container.clientWidth * SYSTEM.pixelRatio;\n    this.canvas.height = this.container.clientWidth * SYSTEM.pixelRatio;\n\n    this.psv.on(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.on('set-markers', this);\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.RENDER, this);\n\n    if (this.markers) {\n      this.markers.off('set-markers', this);\n    }\n\n    this.psv.container.removeChild(this.container);\n\n    delete this.canvas;\n    delete this.container;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    switch (e.type) {\n      case CONSTANTS.EVENTS.RENDER:\n        this.__update();\n        break;\n      case 'set-markers':\n        this.prop.markers = e.args[0].filter(m => m.data?.compass);\n        this.__update();\n        break;\n      case 'mouseenter':\n      case 'mousemove':\n      case 'touchmove':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        if (this.prop.mouseDown) {\n          this.__click();\n        }\n        else {\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mousedown':\n      case 'touchstart':\n        this.prop.mouseDown = true;\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseup':\n      case 'touchend':\n        this.prop.mouse = e.changedTouches?.[0] || e;\n        this.prop.mouseDown = false;\n        this.__click();\n        if (e.changedTouches) {\n          this.prop.mouse = null;\n          this.__update();\n        }\n        e.stopPropagation();\n        e.preventDefault();\n        break;\n      case 'mouseleave':\n        this.prop.mouse = null;\n        this.prop.mouseDown = false;\n        this.__update();\n        break;\n      default:\n        break;\n    }\n  }\n\n  /**\n   * @summary Hides the compass\n   */\n  hide() {\n    this.container.style.display = 'none';\n    this.prop.visible = false;\n  }\n\n  /**\n   * @summary Shows the compass\n   */\n  show() {\n    this.container.style.display = '';\n    this.prop.visible = true;\n  }\n\n  /**\n   * @summary Changes the hotspots on the compass\n   * @param {PSV.plugins.CompassPlugin.Hotspot[]} hotspots\n   */\n  setHotspots(hotspots) {\n    this.config.hotspots = hotspots;\n    this.__update();\n  }\n\n  /**\n   * @summary Removes all hotspots\n   */\n  clearHotspots() {\n    this.setHotspots(null);\n  }\n\n  /**\n   * @summary Updates the compass for current zoom and position\n   * @private\n   */\n  __update() {\n    const context = this.canvas.getContext('2d');\n    context.clearRect(0, 0, this.canvas.width, this.canvas.height);\n\n    const longitude = this.psv.getPosition().longitude;\n    const fov = MathUtils.degToRad(this.psv.prop.hFov);\n\n    this.__drawCone(context, this.config.coneColor, longitude, fov);\n\n    const mouseAngle = this.__getMouseAngle();\n    if (mouseAngle !== null) {\n      this.__drawCone(context, this.config.navigationColor, mouseAngle, fov);\n    }\n\n    this.prop.markers.forEach((marker) => {\n      this.__drawMarker(context, marker);\n    });\n    this.config.hotspots?.forEach((spot) => {\n      if ('longitude' in spot && !('latitude' in spot)) {\n        spot.latitude = 0;\n      }\n      const pos = this.psv.dataHelper.cleanPosition(spot);\n      this.__drawPoint(context, spot.color || this.config.hotspotColor, pos.longitude, pos.latitude);\n    });\n  }\n\n  /**\n   * @summary Rotates the viewer depending on the position of the mouse on the compass\n   * @private\n   */\n  __click() {\n    const mouseAngle = this.__getMouseAngle();\n\n    if (mouseAngle !== null) {\n      this.psv.rotate({\n        longitude: mouseAngle,\n        latitude : 0,\n      });\n    }\n  }\n\n  /**\n   * @summary Draw a cone\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} fov\n   * @private\n   */\n  __drawCone(context, color, longitude, fov) {\n    const a1 = longitude - Math.PI / 2 - fov / 2;\n    const a2 = a1 + fov;\n    const c = this.canvas.width / 2;\n\n    context.beginPath();\n    context.moveTo(c, c);\n    context.lineTo(c + Math.cos(a1) * c, c + Math.sin(a1) * c);\n    context.arc(c, c, c, a1, a2, false);\n    context.lineTo(c, c);\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Draw a Marker\n   * @param {CanvasRenderingContext2D} context\n   * @param {PSV.plugins.MarkersPlugin.Marker} marker\n   * @private\n   */\n  __drawMarker(context, marker) {\n    let color = this.config.hotspotColor;\n    if (typeof marker.data.compass === 'string') {\n      color = marker.data.compass;\n    }\n\n    if (marker.isPoly()) {\n      context.beginPath();\n      marker.props.def.forEach(([longitude, latitude], i) => {\n        const a = longitude - Math.PI / 2;\n        const d = (latitude + Math.PI / 2) / Math.PI;\n        const c = this.canvas.width / 2;\n\n        context[i === 0 ? 'moveTo' : 'lineTo'](c + Math.cos(a) * c * d, c + Math.sin(a) * c * d);\n      });\n      if (marker.isPolygon()) {\n        context.fillStyle = color;\n        context.fill();\n      }\n      else {\n        context.strokeStyle = color;\n        context.lineWidth = Math.max(1, this.canvas.width * HOTSPOT_SIZE_RATIO / 2);\n        context.stroke();\n      }\n    }\n    else {\n      const pos = marker.props.position;\n      this.__drawPoint(context, color, pos.longitude, pos.latitude);\n    }\n  }\n\n  /**\n   * @summary Draw a point\n   * @param {CanvasRenderingContext2D} context\n   * @param {string} color\n   * @param {number} longitude - in viewer reference\n   * @param {number} latitude - in viewer reference\n   * @private\n   */\n  __drawPoint(context, color, longitude, latitude) {\n    const a = longitude - Math.PI / 2;\n    const d = (latitude + Math.PI / 2) / Math.PI;\n    const c = this.canvas.width / 2;\n    const r = Math.max(2, this.canvas.width * HOTSPOT_SIZE_RATIO);\n\n    context.beginPath();\n    context.ellipse(\n      c + Math.cos(a) * c * d, c + Math.sin(a) * c * d,\n      r, r,\n      0, 0, Math.PI * 2\n    );\n    context.fillStyle = color;\n    context.fill();\n  }\n\n  /**\n   * @summary Gets the longitude corresponding to the mouse position on the compass\n   * @return {number | null}\n   * @private\n   */\n  __getMouseAngle() {\n    if (!this.prop.mouse) {\n      return null;\n    }\n\n    const boundingRect = this.container.getBoundingClientRect();\n    const mouseX = this.prop.mouse.clientX - boundingRect.left - boundingRect.width / 2;\n    const mouseY = this.prop.mouse.clientY - boundingRect.top - boundingRect.width / 2;\n\n    if (Math.sqrt(mouseX * mouseX + mouseY * mouseY) > boundingRect.width / 2) {\n      return null;\n    }\n\n    return Math.atan2(mouseY, mouseX) + Math.PI / 2;\n  }\n\n}\n"],"names":["HOTSPOT_SIZE_RATIO","CompassPlugin","psv","options","config","size","position","backgroundSvg","compass","coneColor","navigation","navigationColor","hotspotColor","utils","cleanPosition","prop","visible","mouse","mouseDown","markers","container","document","createElement","className","join","innerHTML","style","width","height","marginTop","marginLeft","canvas","appendChild","addEventListener","init","getPlugin","clientWidth","SYSTEM","pixelRatio","on","CONSTANTS","EVENTS","RENDER","destroy","off","removeChild","handleEvent","e","type","__update","args","filter","m","data","changedTouches","__click","stopPropagation","preventDefault","hide","display","show","setHotspots","hotspots","clearHotspots","context","getContext","clearRect","longitude","getPosition","fov","MathUtils","degToRad","hFov","__drawCone","mouseAngle","__getMouseAngle","forEach","marker","__drawMarker","spot","latitude","pos","dataHelper","__drawPoint","color","rotate","a1","Math","PI","a2","c","beginPath","moveTo","lineTo","cos","sin","arc","fillStyle","fill","isPoly","props","def","i","a","d","isPolygon","strokeStyle","lineWidth","max","stroke","r","ellipse","boundingRect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","sqrt","atan2","AbstractPlugin","id"],"mappings":"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"}