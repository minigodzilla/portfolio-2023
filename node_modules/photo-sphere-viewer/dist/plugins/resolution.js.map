{"version":3,"file":"resolution.js","sources":["../../src/plugins/resolution/constants.js","../../src/plugins/resolution/index.js"],"sourcesContent":["/**\n * @summary Available events\n * @enum {string}\n * @memberof PSV.plugins.ResolutionPlugin\n * @constant\n */\nexport const EVENTS = {\n  /**\n   * @event resolution-changed\n   * @memberof PSV.plugins.ResolutionPlugin\n   * @summary Triggered when the resolution is changed\n   * @param {string} resolutionId\n   */\n  RESOLUTION_CHANGED: 'resolution-changed',\n};\n","import { AbstractPlugin, CONSTANTS, DEFAULTS, PSVError, utils } from '../..';\nimport { EVENTS } from './constants';\n\n\n/**\n * @typedef {Object} PSV.plugins.ResolutionPlugin.Resolution\n * @property {string} id\n * @property {string} label\n * @property {*} panorama\n */\n\n/**\n * @typedef {Object} PSV.plugins.ResolutionPlugin.Options\n * @property {PSV.plugins.ResolutionPlugin.Resolution[]} resolutions - list of available resolutions\n * @property {string} [defaultResolution] - the default resolution if no panorama is configured on the viewer\n * @property {boolean} [showBadge=true] - show the resolution id as a badge on the settings button\n */\n\n\nDEFAULTS.lang.resolution = 'Quality';\n\n\nexport { EVENTS } from './constants';\n\n\n/**\n * @summary Adds a setting to choose between multiple resolutions of the panorama.\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class ResolutionPlugin extends AbstractPlugin {\n\n  static id = 'resolution';\n\n  static EVENTS = EVENTS;\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.ResolutionPlugin.Options} options\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @type {PSV.plugins.SettingsPlugin}\n     * @readonly\n     * @private\n     */\n    this.settings = null;\n\n    /**\n     * @summary Available resolutions\n     * @member {PSV.plugins.ResolutionPlugin.Resolution[]}\n     */\n    this.resolutions = [];\n\n    /**\n     * @summary Available resolutions\n     * @member {Object.<string, PSV.plugins.ResolutionPlugin.Resolution>}\n     * @private\n     */\n    this.resolutionsById = {};\n\n    /**\n     * @type {Object}\n     * @property {string} resolution - Current resolution\n     * @private\n     */\n    this.prop = {\n      resolution: null,\n    };\n\n    /**\n     * @type {PSV.plugins.ResolutionPlugin.Options}\n     */\n    this.config = {\n      showBadge: true,\n      ...options,\n    };\n\n    if (this.config.defaultResolution && this.psv.config.panorama) {\n      utils.logWarn('ResolutionPlugin, a defaultResolution was provided '\n        + 'but a panorama is already configured on the viewer, '\n        + 'the defaultResolution will be ignored.');\n    }\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.settings = this.psv.getPlugin('settings');\n\n    if (!this.settings) {\n      throw new PSVError('Resolution plugin requires the Settings plugin');\n    }\n\n    this.settings.addSetting({\n      id     : ResolutionPlugin.id,\n      type   : 'options',\n      label  : this.psv.config.lang.resolution,\n      current: () => this.prop.resolution,\n      options: () => this.__getSettingsOptions(),\n      apply  : resolution => this.__setResolutionIfExists(resolution),\n      badge  : !this.config.showBadge ? null : () => this.prop.resolution,\n    });\n\n    this.psv.on(CONSTANTS.EVENTS.PANORAMA_LOADED, this);\n\n    if (this.config.resolutions) {\n      this.setResolutions(this.config.resolutions, this.psv.config.panorama ? null : this.config.defaultResolution);\n      delete this.config.resolutions;\n      delete this.config.defaultResolution;\n    }\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.PANORAMA_LOADED, this);\n\n    this.settings.removeSetting(ResolutionPlugin.id);\n\n    super.destroy();\n  }\n\n  /**\n   * @summary Handles events\n   * @param {Event} e\n   * @private\n   */\n  handleEvent(e) {\n    if (e.type === CONSTANTS.EVENTS.PANORAMA_LOADED) {\n      this.__refreshResolution();\n    }\n  }\n\n  /**\n   * @summary Changes the available resolutions\n   * @param {PSV.plugins.ResolutionPlugin.Resolution[]} resolutions\n   * @param {string} [defaultResolution] - if not provided, the current panorama is kept\n   */\n  setResolutions(resolutions, defaultResolution) {\n    this.resolutions = resolutions;\n    this.resolutionsById = {};\n\n    resolutions.forEach((resolution) => {\n      if (!resolution.id) {\n        throw new PSVError('Missing resolution id');\n      }\n      this.resolutionsById[resolution.id] = resolution;\n    });\n\n    // pick first resolution if no default provided and no current panorama\n    if (!this.psv.config.panorama && !defaultResolution) {\n      defaultResolution = resolutions[0].id;\n    }\n\n    // ensure the default resolution exists\n    if (defaultResolution && !this.resolutionsById[defaultResolution]) {\n      utils.logWarn(`Resolution ${defaultResolution} unknown`);\n      defaultResolution = resolutions[0].id;\n    }\n\n    if (defaultResolution) {\n      this.setResolution(defaultResolution);\n    }\n\n    this.__refreshResolution();\n  }\n\n  /**\n   * @summary Changes the current resolution\n   * @param {string} id\n   * @throws {PSVError} if the resolution does not exist\n   */\n  setResolution(id) {\n    if (!this.resolutionsById[id]) {\n      throw new PSVError(`Resolution ${id} unknown`);\n    }\n\n    return this.__setResolutionIfExists(id);\n  }\n\n  /**\n   * @private\n   * @return {Promise}\n   */\n  __setResolutionIfExists(id) {\n    if (this.resolutionsById[id]) {\n      return this.psv.setPanorama(this.resolutionsById[id].panorama, { transition: false, showLoader: false });\n    }\n    else {\n      return Promise.resolve();\n    }\n  }\n\n  /**\n   * @summary Returns the current resolution\n   * @return {string}\n   */\n  getResolution() {\n    return this.prop.resolution;\n  }\n\n  /**\n   * @summary Updates current resolution on panorama load\n   * @private\n   */\n  __refreshResolution() {\n    const resolution = this.resolutions.find(r => utils.deepEqual(this.psv.config.panorama, r.panorama));\n    if (this.prop.resolution !== resolution?.id) {\n      this.prop.resolution = resolution?.id;\n      this.settings?.updateButton();\n      this.trigger(EVENTS.RESOLUTION_CHANGED, this.prop.resolution);\n    }\n  }\n\n  /**\n   * @summary Returns options for Settings plugin\n   * @return {PSV.plugins.SettingsPlugin.Option[]}\n   * @private\n   */\n  __getSettingsOptions() {\n    return this.resolutions\n      .map(resolution => ({\n        id   : resolution.id,\n        label: resolution.label,\n      }));\n  }\n\n}\n"],"names":["EVENTS","RESOLUTION_CHANGED","DEFAULTS","lang","resolution","ResolutionPlugin","psv","options","settings","resolutions","resolutionsById","prop","config","showBadge","defaultResolution","panorama","utils","logWarn","init","getPlugin","PSVError","addSetting","id","type","label","current","__getSettingsOptions","apply","__setResolutionIfExists","badge","on","CONSTANTS","PANORAMA_LOADED","setResolutions","destroy","off","removeSetting","handleEvent","e","__refreshResolution","forEach","setResolution","setPanorama","transition","showLoader","Promise","resolve","getResolution","find","r","deepEqual","updateButton","trigger","map","AbstractPlugin"],"mappings":"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"}